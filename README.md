# CpuIdPkg

---

# ğŸ› ï¸ CPU / MSR / MTRR æ¸¬è©¦èˆ‡æª¢æ¸¬å·¥å…·é–‹ç™¼æŒ‡å—

æœ¬å°ˆæ¡ˆæ˜¯ä¸€å€‹åŸºæ–¼ UEFI (EDK2) ç’°å¢ƒçš„åº•å±¤ç¡¬é«”æª¢æ¸¬å·¥å…·ã€‚ä¸»è¦åŠŸèƒ½æ¶µè“‹è™•ç†å™¨è³‡è¨Šè­˜åˆ¥ (CPUID)ã€åº•å±¤æš«å­˜å™¨è®€å¯« (MSR)ï¼Œä»¥åŠè¨˜æ†¶é«”å¿«å–å±¬æ€§è§£æ (MTRR)ã€‚

ç‚ºç¢ºä¿ç³»çµ±ç©©å®šæ€§ï¼Œæœ¬å·¥å…·å¯¦ä½œäº†ç¡¬é«”ä¾‹å¤–æ””æˆªæ©Ÿåˆ¶ (Exception Handling)ï¼Œèƒ½æœ‰æ•ˆé˜²æ­¢ç›²æƒæš«å­˜å™¨æ™‚å¼•ç™¼çš„ç³»çµ±ç•¶æ©Ÿ (#GP Fault)ã€‚

---

## ğŸ“– ç¬¬ä¸€éƒ¨åˆ†ï¼šæ ¸å¿ƒåŸºæœ¬æ¦‚å¿µ (Basic Concepts)

åœ¨æ“ä½œæœ¬å·¥å…·å‰ï¼Œè«‹å…ˆç†è§£ä»¥ä¸‹ä¸‰å€‹ x86 æ¶æ§‹çš„æ ¸å¿ƒçµ„ä»¶ï¼š

### 1. CPUID (CPU Identification)

* **æ˜¯ä»€éº¼**ï¼šCPUID æ˜¯ä¸€å€‹ x86 çµ„åˆèªè¨€æŒ‡ä»¤ï¼Œç”¨æ–¼æŸ¥è©¢è™•ç†å™¨çš„è£½é€ å•†ã€å‹è™Ÿã€æ¶æ§‹ç‰¹å¾µï¼ˆå¦‚æ˜¯å¦æ”¯æ´ VT-xã€MSRã€MTRR ç­‰ï¼‰ã€‚
* **é‹ä½œåŸç†**ï¼š
è»Ÿé«”å°‡ã€ŒåŠŸèƒ½è™Ÿç¢¼ (Leaf)ã€æ”¾å…¥ `EAX` æš«å­˜å™¨ï¼ˆæœ‰æ™‚åŠ ä¸Š `ECX` ä½œç‚º Sub-Leafï¼‰ï¼Œæ¥è‘—å‘¼å« `cpuid` æŒ‡ä»¤ã€‚CPU æœƒå°‡æŸ¥è©¢çµæœå¡«å…¥ `EAX`ã€`EBX`ã€`ECX`ã€`EDX` å››å€‹æš«å­˜å™¨ä¸­å›å‚³ã€‚
* **ç¯„åœåŠƒåˆ†**ï¼š
* **åŸºæœ¬ç¯„åœ (Basic Range)**ï¼šLeaf `0x00000000` ~ `0x000000XX`ï¼ˆåŒ…å«ä¾›æ‡‰å•†å­—ä¸²ã€æœ€å¤§åŸºç¤åŠŸèƒ½è™Ÿã€ç‰¹å¾µä½å…ƒï¼‰ã€‚
* **æ“´å……ç¯„åœ (Extended Range)**ï¼šLeaf `0x80000000` ~ `0x800000XX`ï¼ˆåŒ…å«è™•ç†å™¨å“ç‰Œåç¨±å­—ä¸²ã€å¯¦é«”ä½å€å¤§å°ç­‰ï¼‰ã€‚



### 2. MSR (Model-Specific Register, ç‰¹å®šå‹è™Ÿæš«å­˜å™¨)

* **æ˜¯ä»€éº¼**ï¼šMSR æ˜¯ CPU å…§éƒ¨ç”¨æ–¼æ§åˆ¶ç¡¬é«”åº•å±¤è¡Œç‚ºã€æ•ˆèƒ½ç›£æ§ã€é›»æºç®¡ç†èˆ‡é™¤éŒ¯çš„ç‰¹æ®Šæš«å­˜å™¨ã€‚
* **å±éšªæ€§èˆ‡ #GP ç•°å¸¸**ï¼š
MSR çš„ä½å€ï¼ˆIndexï¼‰æ˜¯**ä¸é€£çºŒä¸”è·³èºçš„**ï¼Œä¸”æœƒéš¨è‘—ä¸åŒå‹è™Ÿçš„ CPU è€Œæ”¹è®Šã€‚å¦‚æœè»Ÿé«”å˜—è©¦ä½¿ç”¨ `rdmsr` æˆ– `wrmsr` æŒ‡ä»¤å»è®€å¯«ä¸€å€‹**è©² CPU æ²’æœ‰å¯¦ä½œï¼ˆæˆ–è¢«ä¿ç•™ï¼‰çš„ MSR ä½å€**ï¼ŒCPU æœƒç«‹åˆ»è§¸ç™¼ `#GP` (General Protection Faultï¼Œä¸­æ–·å‘é‡ 13)ï¼Œå°è‡´ç³»çµ±ç•¶æ©Ÿæˆ–é‡å•Ÿã€‚
* **å¸¸è¦‹ MSR**ï¼š
* `0x10` (TSC): Time Stamp Counterï¼Œè¨˜éŒ„é–‹æ©Ÿä»¥ä¾†çš„æ™‚è„ˆé€±æœŸã€‚
* `0xCE` (Platform Info): åŒ…å«åŸºç¤æ™‚è„ˆæ¯”ä¾‹ç­‰è³‡è¨Šã€‚



### 3. MTRR (Memory Type Range Register, è¨˜æ†¶é«”é¡å‹ç¯„åœæš«å­˜å™¨)

* **æ˜¯ä»€éº¼**ï¼šMTRR æ˜¯ä¸€çµ„ç‰¹æ®Šçš„ MSRï¼Œè² è²¬å‘Šè¨´ CPUï¼šã€Œé€™æ®µå¯¦é«”è¨˜æ†¶é«”å€é–“æ‡‰è©²ä½¿ç”¨ä»€éº¼æ¨£çš„å¿«å–ç­–ç•¥ (Cacheability)ã€ã€‚
* **å¸¸è¦‹è¨˜æ†¶é«”é¡å‹**ï¼š
* **WB (Write-Back, 0x06)**ï¼šæœ€é«˜æ•ˆèƒ½ï¼Œè³‡æ–™å…ˆå¯«å…¥ Cacheï¼Œé©ç”¨æ–¼ä¸€èˆ¬ç³»çµ±ä¸»è¨˜æ†¶é«”ã€‚
* **UC (Uncacheable, 0x00)**ï¼šä¸ä½¿ç”¨ Cacheï¼Œæ‰€æœ‰è®€å¯«ç›´æ¥å°æ‡‰åˆ°ç¡¬é«”ï¼Œé©ç”¨æ–¼ MMIO (Memory-Mapped I/Oï¼Œå¦‚ PCIe è£ç½®çš„æš«å­˜å™¨)ã€‚
* **WC (Write-Combining, 0x01)**ï¼šå°‡å¤šæ¬¡å°å¯«å…¥åˆä½µæˆä¸€æ¬¡å¤§å¯«å…¥ï¼Œé©ç”¨æ–¼é¡¯ç¤ºå¡çš„ Framebufferã€‚


* **æ¶æ§‹åŠƒåˆ†**ï¼š
* **å›ºå®šç¯„åœ (Fixed Range MTRRs)**ï¼šå›ºå®šæ§åˆ¶ `0x00000` åˆ° `0xFFFFF` (å‰ 1MB) çš„è¨˜æ†¶é«”ï¼Œåˆ‡åˆ†æˆ 64KBã€16KBã€4KB ç­‰å°å€å¡Šï¼Œå¸¸ç”¨æ–¼å‚³çµ± VGA è¨˜æ†¶é«”èˆ‡ BIOS ROM çš„å®šå€ã€‚
* **è®Šå‹•ç¯„åœ (Variable Range MTRRs)**ï¼šç”± Base (åŸºåº•ä½å€) èˆ‡ Mask (é®ç½©å¤§å°) å…©å€‹ MSR çµ„æˆä¸€å°ï¼Œç”¨ä¾†å®šç¾© 1MB ä»¥ä¸Šå¤§å®¹é‡è¨˜æ†¶é«”çš„å¿«å–å±¬æ€§ã€‚



---

## ğŸ’» ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒå‡½æ•¸ä½¿ç”¨æ–¹æ³• (API Notes)

æœ¬å°ˆæ¡ˆæä¾›äº†ä¸€ç³»åˆ—å®‰å…¨çš„ C èªè¨€å°è£å‡½æ•¸ï¼Œæ–¹ä¾¿é–‹ç™¼è€…é€²è¡Œç¡¬é«”è®€å¯«ã€‚

### ğŸ›¡ï¸ å®‰å…¨ MSR è®€å¯« API (Exception-Safe)

åº•å±¤ä¾è³´ `EFI_CPU_ARCH_PROTOCOL` å¯¦ä½œä¸­æ–·æ””æˆªï¼Œç›²æƒ MSR æ™‚çµ•å°ä¸æœƒç•¶æ©Ÿã€‚

#### `SafeReadMsr`

å®‰å…¨åœ°è®€å– MSRï¼Œè‹¥ä½å€ä¸å­˜åœ¨æœƒå„ªé›…åœ°å›å‚³å¤±æ•—ï¼Œè€Œéæ­»æ©Ÿã€‚

* **å®šç¾©**ï¼š`STATIC BOOLEAN SafeReadMsr (IN UINT32 Index, OUT UINT64 *Value);`
* **åƒæ•¸**ï¼š
* `Index` (è¼¸å…¥)ï¼šè¦è®€å–çš„ MSR 16 é€²ä½ä½å€ã€‚
* `Value` (è¼¸å‡º)ï¼šç”¨ä¾†æ¥æ”¶ 64-bit çµæœçš„æŒ‡æ¨™ã€‚


* **å›å‚³**ï¼š`TRUE` (è®€å–æˆåŠŸ), `FALSE` (è§¸ç™¼ #GPï¼Œè©² MSR ä¸å­˜åœ¨)ã€‚
* **ç¯„ä¾‹**ï¼š
```c
UINT64 MsrData;
if (SafeReadMsr(0x10, &MsrData)) {
    Print(L"TSC æ•¸å€¼: 0x%016lx\n", MsrData);
}

```



#### `SafeWriteMsr`

å®‰å…¨åœ°å¯«å…¥ MSRï¼Œé˜²ç¯„å¯«å…¥å”¯è®€æš«å­˜å™¨å°è‡´çš„å´©æ½°ã€‚

* **å®šç¾©**ï¼š`STATIC BOOLEAN SafeWriteMsr (IN UINT32 Index, IN UINT64 Value);`
* **åƒæ•¸**ï¼š
* `Index` (è¼¸å…¥)ï¼šç›®æ¨™ MSR ä½å€ã€‚
* `Value` (è¼¸å…¥)ï¼šæ¬²å¯«å…¥çš„ 64-bit æ•¸å€¼ã€‚


* **å›å‚³**ï¼š`TRUE` (å¯«å…¥æˆåŠŸ), `FALSE` (å¯«å…¥é­æ‹’çµ•æˆ–ä¸å­˜åœ¨)ã€‚

---

### ğŸ” ç¡¬é«”ç‰¹å¾µæª¢æ¸¬ API

#### `CpuSupportsMsr` / `CpuSupportsMtrr`

é€éè§£æ CPUID Leaf 1 çš„ EDX æš«å­˜å™¨ï¼Œç¢ºèªç•¶å‰ç¡¬é«”æ˜¯å¦æ”¯æ´å°æ‡‰æ¶æ§‹ã€‚

* **å®šç¾©**ï¼š
```c
STATIC BOOLEAN CpuSupportsMsr (VOID);
STATIC BOOLEAN CpuSupportsMtrr (VOID);

```


* **å›å‚³**ï¼š`TRUE` (æ”¯æ´) / `FALSE` (ä¸æ”¯æ´)ã€‚

#### `GetPhysicalAddressBits`

å–å¾— CPU ç¡¬é«”çš„å¯¦é«”ä½å€ç·šå¯¬åº¦ (é€šå¸¸ç‚º 36, 39 æˆ– 46 bits)ã€‚æ­¤æ•¸å€¼æ˜¯è¨ˆç®— Variable MTRR å¯¦éš›æ¶µè“‹è¨˜æ†¶é«”å¤§å°çš„é—œéµã€‚

* **å®šç¾©**ï¼š`STATIC UINT8 GetPhysicalAddressBits (VOID);`
* **å›å‚³**ï¼šä½å…ƒæ•¸ (UINT8)ã€‚

---

### ğŸ–¥ï¸ UI èˆ‡äº’å‹•è¼”åŠ© API

#### `PromptHexUint32` / `PromptHexUint64`

åœ¨ç•«é¢ä¸Šå°å‡ºæç¤ºå­—å…ƒï¼Œè®€å–ä½¿ç”¨è€…çš„éµç›¤è¼¸å…¥ï¼Œä¸¦å®‰å…¨åœ°å°‡å­—ä¸²è§£æç‚º 16 é€²ä½æ•¸å€¼ã€‚

* **å®šç¾©**ï¼š`STATIC BOOLEAN PromptHexUint32 (IN CONST CHAR16 *Prompt, OUT UINT32 *Value);`
* **å›å‚³**ï¼š`TRUE` (è§£ææˆåŠŸ), `FALSE` (åŒ…å«éæ³•å­—å…ƒæˆ–ç‚ºç©º)ã€‚

#### `PageLineAccountingEx`

è™•ç†çµ‚ç«¯æ©Ÿç•«é¢çš„ã€Œåˆ†é æš«åœã€é‚è¼¯ã€‚ç•¶å°å‡ºå¤§é‡è³‡æ–™æ™‚ï¼ˆå¦‚ Dump æ‰€æœ‰ CPUIDï¼‰ï¼Œæ­¤å‡½æ•¸æœƒè‡ªå‹•åœ¨é”åˆ°ç•«é¢åº•ç«¯æ™‚æš«åœï¼Œä¸¦è©¢å•æ˜¯å¦ç¹¼çºŒã€‚

* **å®šç¾©**ï¼š`STATIC BOOLEAN PageLineAccountingEx (IN OUT UINTN *LineCount, IN VOID (*ReprintHeader)(VOID), IN UINTN HeaderLines);`
* **åƒæ•¸**ï¼š
* `LineCount`ï¼šç›®å‰è¢å¹•å·²å°å‡ºå¹¾è¡Œçš„è¨ˆæ•¸å™¨æŒ‡æ¨™ã€‚
* `ReprintHeader`ï¼šæ›é å¾Œé‡ç¹ªè¡¨æ ¼æ¨™é¡Œçš„å‡½æ•¸æŒ‡æ¨™ (è‹¥ç„¡å¯å‚³ `NULL`)ã€‚
* `HeaderLines`ï¼šæ¨™é¡Œä½”ç”¨çš„è¡Œæ•¸ã€‚


* **å›å‚³**ï¼š`TRUE` (ä½¿ç”¨è€…æŒ‰ä¸‹ 'q' è¦æ±‚ä¸­æ–·é¡¯ç¤º), `FALSE` (æ­£å¸¸ç¿»é ç¹¼çºŒ)ã€‚

---

## âš¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®‰å…¨æ¸¬è©¦æ¸…å–® (Quick Test)

è‹¥è¦é©—è­‰å·¥å…·æ˜¯å¦æ­£å¸¸é‹ä½œï¼Œå»ºè­°åœ¨ `Read MSR` åŠŸèƒ½ä¸­è¼¸å…¥ä»¥ä¸‹ä¿è­‰å­˜åœ¨çš„å®‰å…¨ä½å€é€²è¡Œæ¸¬è©¦ï¼š

* `10`ï¼šTime Stamp Counter (æ‡‰è§€å¯Ÿåˆ°æ•¸å€¼ä¸æ–·è®Šå¤§)ã€‚
* `CE`ï¼šPlatform Infoã€‚
* `FE`ï¼šMTRRCAP (MTRR èƒ½åŠ›æš«å­˜å™¨)ã€‚
* `2FF`ï¼šMTRR_DEF_TYPE (MTRR é è¨­å¿«å–é¡å‹)ã€‚

*(è¨»ï¼šè‹¥ä½¿ç”¨ `Dump MSR`ï¼Œæ‚¨å¯ä»¥å¤§è†½è¨­å®š Start ç‚º `0x00`ï¼ŒEnd ç‚º `0xFF`ï¼Œè§€å¯Ÿ `SafeReadMsr` å¦‚ä½•å„ªé›…åœ°å°‡ä¸å­˜åœ¨çš„ä½å€æ¨™ç¤ºç‚º `[Invalid / #GP]` è€Œä¸å¼•ç™¼ç•¶æ©Ÿã€‚)*

## ç³»çµ±æ¶æ§‹èˆ‡ä¸»é¸å–®æµç¨‹ (System Architecture & Menu Flow)

```
[ UEFI é€²å…¥é» (UefiMain) ]
       â”‚
       â”œâ”€ 1. æ¸…ç©ºéµç›¤è¼¸å…¥ç·©è¡å€ (ConIn->Reset)
       â”œâ”€ 2. å°‹æ‰¾ä¸¦ç¶å®š CPU Protocol (LocateProtocol) â”€â”€> å–å¾— mCpu æŒ‡æ¨™
       â”‚
       â–¼
[ ä¸»é¸å–®è¿´åœˆ (RunMainMenu) ] <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                                 â”‚
       â”œâ”€ é‡ç¹ª UI ä»‹é¢ (ShowHeaderAndMenu)               â”‚
       â”œâ”€ é˜»å¡ç­‰å¾…ä½¿ç”¨è€…æŒ‰éµ (ReadKeyBlocking)           â”‚
       â”‚                                                 â”‚
       â”œâ”€ [â†‘] / [â†“] æ–¹å‘éµ: ç§»å‹•é¸å–®çš„åç™½æ¸¸æ¨™           â”‚
       â”œâ”€ [ESC] éµ: é€€å‡ºç¨‹å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(çµæŸç¨‹å¼) â”‚
       â”‚                                                 â”‚
       â””â”€ [Enter] éµ: é€²å…¥é¸ä¸­çš„åŠŸèƒ½åˆ†æ”¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                         â”‚
=========================================================â”‚
åŠŸèƒ½åˆ†æ”¯ (Feature Branches)                              â”‚
=========================================================â”‚
                                                         â”‚
[0] CPU ID å–®æ¬¡æŸ¥è©¢ (DoCpuId)                            â”‚
 â”‚  â”œâ”€ æç¤ºè¼¸å…¥ Leaf (16é€²ä½)                            â”‚
 â”‚  â”œâ”€ åŸ·è¡Œ AsmCpuid æå–ç‰¹å¾µç¢¼                          â”‚
 â”‚  â””â”€ å°å‡º EAX, EBX, ECX, EDX (è‡ªå‹•è§£æ Leaf 0, 1)      â”‚
 â”‚                                                       â”‚
[1] Dump CPU ID å®Œæ•´å‚¾å° (DoDumpCpuId)                   â”‚
 â”‚  â”œâ”€ æŸ¥è©¢æœ€å¤§åŸºç¤åŠŸèƒ½è™Ÿ (Max Basic Leaf)               â”‚
 â”‚  â”œâ”€ è¿´åœˆ: 0x00000000 -> Max Basic                     â”‚
 â”‚  â”œâ”€ æŸ¥è©¢æœ€å¤§æ“´å……åŠŸèƒ½è™Ÿ (Max Ext. Leaf)                â”‚
 â”‚  â”œâ”€ è¿´åœˆ: 0x80000000 -> Max Ext.                      â”‚
 â”‚  â””â”€ è§£æä¸¦å°å‡º CPU å“ç‰Œå­—ä¸² (Brand String)            â”‚
 â”‚     (è¨»: å‚¾å°éç¨‹çš†å— PageLineAccountingEx åˆ†é æ§åˆ¶)  â”‚
 â”‚                                                       â”‚
[2] Read MSR è®€å–å–®ä¸€æš«å­˜å™¨ (DoReadMsr)                  â”‚
 â”‚  â”œâ”€ æç¤ºè¼¸å…¥ MSR Index                                â”‚
 â”‚  â””â”€ å‘¼å« SafeReadMsr() â”€â”€(è‹¥ä¸å­˜åœ¨å‰‡é¡¯ç¤º #GP è­¦å‘Š)    â”‚
 â”‚                                                       â”‚
[3] Dump MSR å€é–“å‚¾å° (DoDumpMsr)                        â”‚
 â”‚  â”œâ”€ æç¤ºè¼¸å…¥ Start Index èˆ‡ End Index                 â”‚
 â”‚  â””â”€ è¿´åœˆ: é€ä¸€æƒæ Start -> End                       â”‚
 â”‚      â”œâ”€ è®€å–æˆåŠŸ: å°å‡º 64-bit æ•¸å€¼                    â”‚
 â”‚      â””â”€ è®€å–å¤±æ•—: å°å‡º [Invalid / #GP] (ç•¥ééŒ¯èª¤)     â”‚
 â”‚                                                       â”‚
[4] Write MSR å¯«å…¥æš«å­˜å™¨ (DoWriteMsr)                    â”‚
 â”‚  â”œâ”€ æç¤ºè¼¸å…¥ Index èˆ‡æ¬²å¯«å…¥çš„ 64-bit Data             â”‚
 â”‚  â”œâ”€ äºŒæ¬¡ç¢ºèª (Y/N) é˜²å‘†æ©Ÿåˆ¶                           â”‚
 â”‚  â””â”€ å‘¼å« SafeWriteMsr() â”€â”€(å¯«å…¥å¾Œé‡æ–° Read-Back é©—è­‰) â”‚
 â”‚                                                       â”‚
[5] Dump MTRR å‚¾å°å¿«å–çµ„æ…‹ (DoDumpMtrr)                  â”‚
 â”‚  â”œâ”€ è®€å– MTRRCAP èˆ‡ MTRR_DEF_TYPE å–å¾—å…¨åŸŸå•Ÿç”¨ç‹€æ…‹    â”‚
 â”‚  â”œâ”€ æŸ¥è©¢å¯¦é«”å®šå€ä½å…ƒæ•¸ (Physical Address Bits)        â”‚
 â”‚  â”œâ”€ Dump Variable Ranges (è§£æ 10 çµ„ Base & Mask)     â”‚
 â”‚  â””â”€ Dump Fixed Ranges (è§£æ 11 å€‹å›ºå®šå€æ®µä¹‹ 8 Bytes)  â”‚
 â”‚                                                       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(åŠŸèƒ½åŸ·è¡Œå®Œç•¢ï¼Œç­‰å¾…ä»»æ„éµ)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

cd /d D:\BIOS\MyWorkSpace\edk2

edksetup.bat Rebuild

chcp 65001

set PYTHONUTF8=1

set PYTHONIOENCODING=utf-8

rmdir /s /q Build\CmosRwAppPkg

build -p CpuIdPkg\CpuIdPkg.dsc -a X64 -t VS2019 -b DEBUG
